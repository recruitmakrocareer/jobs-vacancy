<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤ - Makro</title>

  <style>
    :root { 
      --max: 1100px; 
      --makro-red: #ED1C24; 
      --makro-red-dark: #c41219;
      --bg-color: #f6f7fb;
    }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background:var(--bg-color); color:#111; }
    
    /* === Header === */
    header { 
      padding:40px 18px; 
      color:#fff; 
      background: linear-gradient(135deg, var(--makro-red) 0%, #ff4d4d 100%); 
      box-shadow: 0 4px 20px rgba(237, 28, 36, 0.2);
    }
    header .wrap { max-width: var(--max); margin:auto; display: flex; align-items: center; gap: 24px; justify-content: space-between; }
    header .logo { width: 140px; height: 80px; object-fit: contain; background: #fff; border-radius: 12px; padding: 12px 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-shrink: 0; }
    header .header-text { flex: 1; }
    header h1 { margin:0 0 8px; font-size:36px; line-height: 1.1; font-weight: 800; letter-spacing: -0.5px; }
    header p { margin:0; font-size:18px; opacity:.95; font-weight: 400; }

    @media (max-width: 600px) {
      header .wrap { flex-direction: column-reverse; text-align: center; gap: 20px; }
      header h1 { font-size: 28px; }
      header .logo { width: 120px; height: auto; padding: 10px 16px; }
    }

    /* === Content === */
    main { max-width: var(--max); margin:auto; padding:24px 18px 60px; }
    .card { background:#fff; border-radius:16px; padding:24px; box-shadow:0 10px 30px rgba(0,0,0,.04); margin-bottom:20px; border: 1px solid rgba(0,0,0,0.03); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    
    .pill { background:#fff1f2; color:var(--makro-red-dark); font-weight:700; font-size:13px; padding:6px 12px; border-radius:999px; letter-spacing: 0.5px; }
    .muted { opacity:.6; font-size: 14px; }

    input, select { padding:12px 16px; border-radius:12px; border:1px solid #e5e7eb; font-size:15px; background:#fff; transition: border-color 0.2s; }
    input:focus, select:focus { outline: none; border-color: var(--makro-red); box-shadow: 0 0 0 3px rgba(237, 28, 36, 0.1); }
    
    .btn { border:0; border-radius:12px; padding:12px 20px; font-weight:600; cursor:pointer; font-size: 15px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .btn.primary { background:var(--makro-red); color:#fff; box-shadow: 0 4px 12px rgba(237, 28, 36, 0.3); }
    .btn.primary:hover { background:var(--makro-red-dark); transform: translateY(-1px); }
    .btn.ghost { background:#f3f4f6; color:#4b5563; }
    .btn.ghost:hover { background:#e5e7eb; color:#111; }
    .btn.outline { background:transparent; border: 1px solid #e5e7eb; color:#4b5563; }
    .btn.outline:hover { border-color: var(--makro-red); color: var(--makro-red); background: #fff1f2; }

    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px; margin-top:20px; }
    
    /* === Job Card (Compact Version) === */
    .job { 
      border:1px solid #f3f4f6; border-radius:16px; padding:20px; background:#fff; 
      transition: all 0.2s ease; position: relative; display: flex; flex-direction: column;
    }
    .job:hover { transform: translateY(-4px); border-color: #fecaca; box-shadow: 0 12px 24px rgba(237, 28, 36, 0.08); }
    .job h3 { margin:12px 0 8px; font-size:18px; line-height:1.4; color: #111827; font-weight: 700; }
    
    .meta { font-size:14px; color: #6b7280; margin-bottom: 16px; flex: 1; }
    .meta div { margin:6px 0; display:flex; align-items:center; gap:8px; }
    
    /* Salary Style */
    .salary-text { color: #059669; font-weight: 600; }

    .status-badge { display:inline-flex; align-items: center; gap:4px; font-size:12px; padding:4px 10px; border-radius:6px; font-weight:600; letter-spacing: 0.3px; }
    .status-open { background:#ecfdf5; color:#059669; border: 1px solid #d1fae5; }

    /* === Modal / Popup Styles === */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5); z-index: 999;
      display: none; justify-content: center; align-items: center;
      padding: 20px; backdrop-filter: blur(4px);
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.2s ease-out; }
    
    .modal-content {
      background: #fff; width: 100%; max-width: 700px; max-height: 90vh;
      border-radius: 20px; overflow-y: auto; position: relative;
      display: flex; flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
    }
    .modal-header {
      padding: 24px; border-bottom: 1px solid #f3f4f6;
      position: sticky; top: 0; background: #fff; z-index: 10;
      display: flex; justify-content: space-between; align-items: start;
    }
    .modal-body { padding: 24px; overflow-y: auto; font-size: 15px; line-height: 1.6; color: #374151; }
    .modal-footer {
      padding: 20px 24px; border-top: 1px solid #f3f4f6;
      background: #f9fafb; display: flex; gap: 12px; justify-content: flex-end;
    }
    
    .close-modal { 
      background: transparent; border: 0; font-size: 24px; color: #9ca3af; cursor: pointer; padding: 0; line-height: 1;
    }
    .close-modal:hover { color: var(--makro-red); }

    .modal-section-title { font-weight: 700; color: #111827; font-size: 16px; margin: 20px 0 10px; display: flex; align-items: center; gap: 8px; }
    .modal-section-title:first-child { margin-top: 0; }
    
    .modal-body ul { margin: 0; padding-left: 20px; }
    .modal-body li { margin-bottom: 6px; }

    iframe { width:100%; height:900px; border:0; border-radius:16px; background:#fff; margin-top:12px; border: 1px solid #e5e7eb; }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--makro-red); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 30px auto; }
    
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="header-text">
      <h1>‡∏£‡πà‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤</h1>
      <p>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
    </div>
    <img id="companyLogo" src="" class="logo" alt="Makro Logo" referrerpolicy="no-referrer" onerror="this.style.display='none'">
  </div>
</header>

<main>
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <span class="pill">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô</span>
        <div class="muted" style="margin-top:4px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à</div>
      </div>
      <button class="btn primary" id="refreshBtn">
        <span style="font-size:18px">‚Üª</span> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô
      </button>
    </div>

    <div class="row" style="margin-top:20px">
      <input id="q" placeholder="üîç ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô, ‡∏™‡∏≤‡∏Ç‡∏≤, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£..." style="flex:1;min-width:240px">
      <select id="filterProvince" style="min-width:160px"><option value="">üìç ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option></select>
      <select id="filterBranch" style="min-width:180px"><option value="">üè¢ ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option></select>
      <button class="btn ghost" id="clearBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
  </section>

  <section class="card">
    <div id="statusMsg" class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    <div id="jobs" class="grid"></div>
  </section>

  <!-- Hidden Apply Section -->
  <section class="card" id="applySection" style="display:none;">
    <span class="pill">‡πÉ‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô</span>
    <p class="muted" style="margin-top:8px">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <b id="applyPositionName" style="color:var(--makro-red)">...</b></p>
    <div id="iframeContainer"></div>
  </section>
</main>

<!-- === MODAL POPUP === -->
<div id="jobModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <div style="flex:1; padding-right:16px;">
        <span class="status-badge status-open" style="margin-bottom:8px">‚óè ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
        <h2 id="modalTitle" style="margin:0; font-size:22px; line-height:1.3;">‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h2>
        <div id="modalBranch" style="color:#6b7280; font-size:14px; margin-top:4px;">‡∏™‡∏≤‡∏Ç‡∏≤</div>
        <div id="modalSalary" style="color:#059669; font-weight:600; font-size:15px; margin-top:6px; display:none;"></div>
      </div>
      <button class="close-modal" onclick="closeModal()">√ó</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn ghost" onclick="closeModal()">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
      <button class="btn primary" id="modalApplyBtn">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ üëâ</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */

// ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå CSV ‡∏Ç‡∏≠‡∏á‡∏ä‡∏µ‡∏ï WebExport (‡∏ó‡∏µ‡πà‡∏°‡∏µ Col A-H ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß)
const GOOGLE_SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ-aAempo3sn5LxfvOq0MRB2YMRs2rFTjocqidMYpwGUKdqG1DGUz5uCEfd3ddNjxStdWifLgBbrqXV/pub?gid=2065374453&single=true&output=csv"; 

const COMPANY_LOGO_URL = "./LOGOT.png"; 

// 3. Microsoft Form Links (‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
const FORM_BASE_URL = "https://forms.office.com/r/wabJfczd4Z"; // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
const FORM_ORDER_PICKER_URL = "https://forms.office.com/r/zdLQKYiYPz"; // ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå

/* ================= LOGIC ================= */

let allJobs = [];
const elQ = document.getElementById("q");
const elFilterProvince = document.getElementById("filterProvince");
const elFilterBranch = document.getElementById("filterBranch");
const elClearBtn = document.getElementById("clearBtn");
const elStatus = document.getElementById("statusMsg");
const elJobs = document.getElementById("jobs");
const elRefreshBtn = document.getElementById("refreshBtn");
const elApplySection = document.getElementById("applySection");
const elApplyPositionName = document.getElementById("applyPositionName");
const elIframeContainer = document.getElementById("iframeContainer");

const modalOverlay = document.getElementById("jobModal");
const modalTitle = document.getElementById("modalTitle");
const modalBranch = document.getElementById("modalBranch");
const modalSalary = document.getElementById("modalSalary");
const modalBody = document.getElementById("modalBody");
const modalApplyBtn = document.getElementById("modalApplyBtn");

window.onload = init;

async function init() {
  if (COMPANY_LOGO_URL) document.getElementById("companyLogo").src = COMPANY_LOGO_URL;
  await loadData();
  
  elQ.addEventListener("input", renderJobs);
  elFilterProvince.addEventListener("change", renderJobs);
  elFilterBranch.addEventListener("change", renderJobs);
  elClearBtn.addEventListener("click", () => {
    elQ.value = ""; elFilterProvince.value = ""; elFilterBranch.value = ""; renderJobs();
  });
  elRefreshBtn.addEventListener("click", loadData);
  modalOverlay.addEventListener("click", (e) => { if (e.target === modalOverlay) closeModal(); });
}

async function loadData() {
  elStatus.innerHTML = '<div class="loader"></div>';
  elJobs.innerHTML = "";
  try {
    const response = await fetch(GOOGLE_SHEET_CSV_URL);
    if (!response.ok) throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
    const text = await response.text();
    const allRows = parseCSV(text); 
    const data = allRows.slice(1);

    allJobs = data.map((row, index) => {
      // Mapping: A(0)Code, B(1)Branch, C(2)PosGroup, D(3)Status, E(4)PosName, F(5)Province, G(6)Desc, H(7)Qual, I(8)Salary
      const rawBranch = row[1] || "";
      const province = row[5] ? row[5].trim() : "";
      const fullBranch = province ? `${rawBranch} (‡∏à.${province})` : rawBranch;
      
      return {
        id: index,
        code: row[0] || "",
        branch: fullBranch, 
        position: row[4] || "", 
        status: row[3] || "Closed",
        province: province,
        desc: row[6] || "", 
        qual: row[7] || "",
        salary: row[8] ? row[8].trim() : "" // Column I (Index 8)
      };
    }).filter(job => job.position && job.branch);

    updateProvinceDropdown();
    updateBranchDropdown();
    renderJobs();
    elStatus.textContent = `‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡πà‡∏≤‡∏á ${allJobs.length} ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ${new Date().toLocaleTimeString('th-TH')})`;
  } catch (error) {
    console.error(error);
    elStatus.innerHTML = `<span style="color:red">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</span>`;
  }
}

function renderJobs() {
  const searchText = elQ.value.toLowerCase();
  const provinceFilter = elFilterProvince.value;
  const branchFilter = elFilterBranch.value;

  const filtered = allJobs.filter(job => {
    const matchSearch = job.position.toLowerCase().includes(searchText) || 
                        job.branch.toLowerCase().includes(searchText) ||
                        job.desc.toLowerCase().includes(searchText) ||
                        job.province.toLowerCase().includes(searchText);
    const matchProvince = provinceFilter === "" || job.province === provinceFilter;
    const matchBranch = branchFilter === "" || job.branch === branchFilter;
    const matchStatus = job.status.toLowerCase().trim() === "open";
    return matchSearch && matchProvince && matchBranch && matchStatus;
  });

  elJobs.innerHTML = "";

  if (filtered.length === 0) {
    elJobs.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;opacity:0.6">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
    return;
  }

  filtered.forEach(job => {
    const card = document.createElement("div");
    card.className = "job";
    
    // Check if salary exists
    const salaryHtml = job.salary ? `<div class="salary-text">üí∞ ${job.salary}</div>` : '';

    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start;">
        <span class="status-badge status-open">‚óè ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
      </div>
      <h3>${job.position}</h3>
      <div class="meta">
        <div>üè¢ <strong>${job.branch}</strong></div>
        ${salaryHtml}
      </div>
      
      <div style="display:flex; gap:8px; margin-top:auto;">
        <button class="btn outline" style="flex:1;" onclick="openJobModal(${job.id})">
          üìñ ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        </button>
        <button class="btn primary" style="flex:1;" onclick="openApplyForm('${job.position}', '${job.branch}')">
          ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏•‡∏¢
        </button>
      </div>
    `;
    elJobs.appendChild(card);
  });
}

function openJobModal(id) {
  const job = allJobs.find(j => j.id === id);
  if (!job) return;

  modalTitle.textContent = job.position;
  modalBranch.textContent = `üè¢ ${job.branch}`;
  
  if (job.salary) {
    modalSalary.textContent = `üí∞ ${job.salary}`;
    modalSalary.style.display = 'block';
  } else {
    modalSalary.style.display = 'none';
  }
  
  let content = '';
  if (job.desc) {
    content += `<div class="modal-section-title">üìã ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏á‡∏≤‡∏ô</div>${formatTextToFullList(job.desc)}`;
  }
  if (job.qual) {
    content += `<div class="modal-section-title">üéì ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</div>${formatTextToFullList(job.qual)}`;
  }
  if (!content) content = '<div class="muted" style="text-align:center; padding:20px;">- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° -</div>';
  
  modalBody.innerHTML = content;
  modalApplyBtn.onclick = function() { closeModal(); openApplyForm(job.position, job.branch); };
  modalOverlay.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  modalOverlay.classList.remove('active');
  document.body.style.overflow = '';
}

function formatTextToFullList(text) {
  if (!text) return "";
  const items = text.split(/\r?\n|‚Ä¢|- /).map(s => s.trim()).filter(s => s);
  if (items.length === 0) return `<p>${text}</p>`;
  let html = "<ul>";
  items.forEach(item => html += `<li>${item}</li>`);
  html += "</ul>";
  return html;
}

window.openApplyForm = function(position, branch) {
  elApplySection.style.display = "block";
  elApplyPositionName.textContent = `${position} (${branch})`;
  elApplySection.scrollIntoView({ behavior: "smooth" });
  
  // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ï‡∏≤‡∏°‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà)
  let targetFormUrl = FORM_BASE_URL;
  if (position.trim() === "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏±‡∏î‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (Picker)") {
    targetFormUrl = FORM_ORDER_PICKER_URL;
  }

  elIframeContainer.innerHTML = `
    <div style="text-align:center; margin-bottom:12px;">
       <a href="${targetFormUrl}" target="_blank" class="btn ghost" style="display:inline-flex; align-items:center; gap:6px; font-size:14px; color:#4b5563; background:#f3f4f6; border:1px solid #e5e7eb;">
         <span>‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á</span> <span style="text-decoration:underline; font-weight:bold;">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà</span>
       </a>
    </div>
    <iframe src="${targetFormUrl}" allowfullscreen></iframe>
  `;
}

function updateProvinceDropdown() {
  const provinces = [...new Set(allJobs.map(j => j.province).filter(p => p))].sort();
  const currentVal = elFilterProvince.value;
  elFilterProvince.innerHTML = '<option value="">üìç ‡∏ó‡∏∏‡∏Å‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>';
  provinces.forEach(p => {
    const opt = document.createElement("option");
    opt.value = p; opt.textContent = p; elFilterProvince.appendChild(opt);
  });
  if (provinces.includes(currentVal)) elFilterProvince.value = currentVal;
}

function updateBranchDropdown() {
  const branches = [...new Set(allJobs.map(j => j.branch))].sort();
  const currentVal = elFilterBranch.value;
  elFilterBranch.innerHTML = '<option value="">üè¢ ‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤</option>';
  branches.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b; opt.textContent = b; elFilterBranch.appendChild(opt);
  });
  if (branches.includes(currentVal)) elFilterBranch.value = currentVal;
}

function parseCSV(text) {
  const lines = text.split(/\r?\n/);
  return lines.map(line => {
    if (!line.trim()) return null;
    const row = []; let inQuote = false; let start = 0;
    for (let i = 0; i < line.length; i++) {
      if (line[i] === '"') inQuote = !inQuote;
      else if (line[i] === ',' && !inQuote) {
        let field = line.substring(start, i);
        if (field.startsWith('"') && field.endsWith('"')) field = field.slice(1, -1).replace(/""/g, '"');
        row.push(field.trim()); start = i + 1;
      }
    }
    let field = line.substring(start);
    if (field.startsWith('"') && field.endsWith('"')) field = field.slice(1, -1).replace(/""/g, '"');
    row.push(field.trim());
    return row;
  }).filter(row => row !== null);
}
</script>

</body>
</html>
